# Python Mastery

## : Beginner Grid-3

DJANGO Framework

### First Django project

```bash
$ pipenv install django
# activate the VENV
#To activate this project's virtualenv, run pipenv shell.
#Alternatively, run a command inside the virtualenv with pipenv run.
$ pipenv shell
```

Now the VENV is active we need to create the django project.

```bash
Alexandros-MacBook-Pro:vidly alexandrodisla$ pipenv shell
Launching subshell in virtual environmentâ€¦
 . /Users/alexandrodisla/.local/share/virtualenvs/vidly-xhLcunrD/bin/activate
bash-3.2$  . /Users/alexandrodisla/.local/share/virtualenvs/vidly-xhLcunrD/bin/activate
(vidly) bash-3.2$ django-admin startproject vidly .
```

Create a boiler plate file system in our directory to start our project.

#### IMportant

Set the vscode pythonPath to path of the virtual environment.

#### Start Server (default port)

```bash
python3 manage.py runserver
```

### First App

**The django app can be breakdown into multiple small apps handeling a specific functionality.**

```bash
(vidly) Alexandros-MacBook-Pro:vidly alexandrodisla$ python3 manage.py startapp movies
```

### Views

Classic Pattern :

- MVC

Django pattern:

- MTV

#### SHow : "Hello World"

> In the movies app `((vidly) Alexandros-MacBook-Pro:vidly alexandrodisla$ python3 manage.py startapp movies)`:

1. we work in the views.py
2. we created urls.py inside the directory

- movies/views

```python
from django.http import HttpResponse
from django.shortcuts import render

# Create your views here.


def index(request):
    return HttpResponse("Hello World")

# create a urls.py to mapp this index
```

- movies/urls (created)

```python
from django.urls import path
from . import views
urlpatterns = [
    path('', views.index, name='index')
]
```

> WE go out the movies directory, (inside the vidly`_djangcreated_dir`)

- vidly/vidly/urls

```python
"""vidly URL Configuration

The `urlpatterns` list routes URLs to views. For more information please see:
    https://docs.djangoproject.com/en/2.2/topics/http/urls/
Examples:
Function views
    1. Add an import:  from my_app import views
    2. Add a URL to urlpatterns:  path('', views.home, name='home')
Class-based views
    1. Add an import:  from other_app.views import Home
    2. Add a URL to urlpatterns:  path('', Home.as_view(), name='home')
Including another URLconf
    1. Import the include() function: from django.urls import include, path
    2. Add a URL to urlpatterns:  path('blog/', include('blog.urls'))
"""
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('movies/', include('movies.urls'))
]
```

### Models

The model is supposed to map our database tables.

** `django.db //=> models` is the class doing the magic.**

- Movies/models

```python
from django.db import models

# Create your models here.


class Genre(models.Model):
    # use field
    name = models.CharField(max_length=255)


class Movie(models.Model):
    # use field
    title = models.CharField(max_length=255)
    release_year = models.IntegerField()
    number_in_stock = models.IntegerField()
    daily_rate = models.FloatField()
    # association has-many and belongs to
    # on delete will tell django how to handle
    # a delete event of a genre given the
    # association
    genre = models.ForeignKey(Genre, on_delete=models.CASCADE)
```

### Migrations

```bash
(venv)bash3.2$ python3 manage.py makemigrations
```

#### Step 1

Before we must register our movies app inside django:

- `Movies/apps.py` := we need `MoviesConfig` class.
- `vidly/settings.py` := put it this class here.

```python
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'movies.apps.MoviesConfig' # Movie (created)
]
```

Django will keep track of our migrations.

WHat is INSIDE:

- Movies/apps

```python
from django.apps import AppConfig


class MoviesConfig(AppConfig):
    name = 'movies'
```

##### migration

```bash
(vidly) bash-3.2$ python3 manage.py makemigrations
Migrations for 'movies':
  movies/migrations/0001_initial.py
    - Create model Genre
    - Create model Movie
```

Now The migration will be valid:

- movies/migrations/0001_initial.py (created)

```python
# Generated by Django 2.2.4 on 2019-08-05 20:35

from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='Genre',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=255)),
            ],
        ),
        migrations.CreateModel(
            name='Movie',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('title', models.CharField(max_length=255)),
                ('release_year', models.IntegerField()),
                ('number_in_stock', models.IntegerField()),
                ('daily_rate', models.FloatField()),
                ('genre', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='movies.Genre')),
            ],
        ),
    ]
```

We need to run the migration NOw

#### Step 2

```bash
(vidly) bash-3.2$ python3 manage.py migrate
```

### Changing the Models

We are adding a `date_created` column to our models `movies/models`

```python
from django.db import models
from django.utils import timezone
# Create your models here.


class Genre(models.Model):
    # use field
    name = models.CharField(max_length=255)


class Movie(models.Model):
    # use field
    title = models.CharField(max_length=255)
    release_year = models.IntegerField()
    number_in_stock = models.IntegerField()
    daily_rate = models.FloatField()
    # association has-many and belongs to
    # on delete will tell django how to handle
    # a delete event of a genre given the
    genre = models.ForeignKey(Genre, on_delete=models.CASCADE)
    # New
    date_created = models.DateTimeField(default=timezone.now)

```

Create a migration.

```bash
(vidly) bash-3.2$ python3 manage.py makemigrations
Migrations for 'movies':
  movies/migrations/0002_movie_date_created.py
    - Add field date_created to movie
```

`movies/migrations/0002_movie_date_created (create)`

```python
# Generated by Django 2.2.4 on 2019-08-06 14:01

from django.db import migrations, models
import django.utils.timezone


class Migration(migrations.Migration):

    dependencies = [
        ('movies', '0001_initial'),
    ]

    operations = [
        migrations.AddField(
            model_name='movie',
            name='date_created',
            field=models.DateTimeField(default=django.utils.timezone.now),
        ),
    ]
```

> The app is already registered

```python
(vidly) bash-3.2$ python3 manage.py migrate
Operations to perform:
  Apply all migrations: admin, auth, contenttypes, movies, sessions
Running migrations:
  Applying movies.0002_movie_date_created... OK
```

#### See the sql statements (if you want)

```bash
# see the sql statement of the first migration
(vidly) bash-3.2$ python3 manage.py sqlmigrate movies 0001
```

### Admin

We are going to take advantage of the powerful administration interface.

```bash
python3 manage.py runserver
```

As we can see we have an admin panel (application) that is avalaible to us.

WHY?

`vidly/vidly/setting.py`

we have, besides the movies app that we registered earlier, an admin and auth apps.

```python
(..)
# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'movies.apps.MoviesConfig'
]
(..)
```

To implement users into our application, We will need a **super user**.

```bash
(vidly)bash3.2$ python3 manage.py createsuperuser
```

Then enter valid credentials

```bash
(vidly) bash-3.2$ python3 manage.py createsuperuser
Username (leave blank to use 'alexandrodisla'): alexandro
Email address: alexandrodisla@hotmail.com
Password:
Password (again):
Superuser created successfully.
```

#### We must now move the components of our movies app into the `django_admin_app`

We GO inside our:

`./movies/admin.py` directory

```python
from django.contrib import admin
# .models means the models module in our current folder
from .models import Genre, Movie
# Register your models here.
admin.site.register(Genre)
admin.site.register(Movie)
```

We are telling django_admin_app to add Movie and Genre to the admin panel.

** you can manage the website with this panel. Which also means administrate the database. because we added the two models above**

### Customizing the admin

We want to modify the representation of our models (Movie; Genre) inside the admin panel.

Go : `movies/models.py'

```python
from django.db import models
from django.utils import timezone
# Create your models here.


class Genre(models.Model):
    # use field
    name = models.CharField(max_length=255)
    # override the default __str__

    def __str__(self):
        return self.name


class Movie(models.Model):
    # use field
    title = models.CharField(max_length=255)
    release_year = models.IntegerField()
    number_in_stock = models.IntegerField()
    daily_rate = models.FloatField()
    # association has-many and belongs to
    # on delete will tell django how to handle
    # a delete event of a genre given the
    genre = models.ForeignKey(Genre, on_delete=models.CASCADE)
    # add a new
    date_created = models.DateTimeField(default=timezone.now)

```

#### Customize the display of the columns

`movies/admin`:

```python
from django.contrib import admin
# .models means the models module in our current folder
from .models import Genre, Movie

# customize the representation of the models in admin panel


class GenreAdmin(admin.ModelAdmin):
    list_display = ("id", "name")


class MovieAdmin(admin.ModelAdmin):

    list_display = ("title", "number_in_stock", "daily_rate")
    # specify the fields we want or not to show
    exclude = ('date_created', )

    # Register your models here.


admin.site.register(Genre, GenreAdmin)
admin.site.register(Movie, MovieAdmin)
```

Now we have a perfect representation of our data base inside the admin panel. we can nice administrate the website.

**This is not the public area**

### Database Abstraction API

We want to view a list of movies in our `/movies` routes.

Go: `movies/views.py`

Just like in ruby, we can pass data from our databse with our models class. `(Class.all)` is avalaible.

```python
from django.http import HttpResponse
from django.shortcuts import render
from .models import Movie

# Create your views here.


def index(request):
    movies = Movie.objects.all()
    output = " ".join([m.title for m in movies])
    return HttpResponse(output)

# create a urls.py to mapp this index

```

Npw we must learn to render these logic inside an html. With Templates....

### Templates

We want to return html elements from our `view` functions.

GO: `movies/views.py`

```python
from django.http import HttpResponse
from django.shortcuts import render
from .models import Movie

# Create your views here.


def index(request):
    movies = Movie.objects.all()
    #output = " ".join([m.title for m in movies])
    # return HttpResponse(output)
    return render(request, 'index.html', {'movies': movies})


# we must create our template now
# create a urls.py to mapp this index
```

Because of the structure of django, it will look the template in all his applications:

`vidly/vidly/settings.py`

```python
# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'movies.apps.MoviesConfig'
]
```

Which means if it will look for the template folder in each of these apps. and it will look for `index.html`. As best practice we must use a **name_space**.

HOW?

We add a folder named movies inside our template folder inside our movies app directory.

- `vidly/movies/templates/movies/index.html`
- Change the code inside the `vidly/movies/views.py`:

```python
from django.http import HttpResponse
from django.shortcuts import render
from .models import Movie

# Create your views here.


def index(request):
    movies = Movie.objects.all()
    #output = " ".join([m.title for m in movies])
    # return HttpResponse(output)
    return render(request, 'movies/index.html', {'movies': movies})


# we must create our template now
# create a urls.py to mapp this index
```

piece of index.html:

```django_html
<body>
  <h1>Vidly</h1>
  <table class="table">
    <thead>
      <th>Title</th>
      <th>Genre</th>
      <th>Stock</th>
      <th>Daily Rate</th>
    </thead>
    <tbody>
      {% for movie in movies %}
      <tr>
        <td>{{movie.title}}</td>
        <td>{{movie.genre}}</td>
        <td>{{movie.number_in_stock}}</td>
        <td>{{movie.daily_rate}}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</body>
```

### Adding Bootstrap

1. We get the starter template from the bootstrap website.

2. create an html files `vidly/movies/templates/movies/base.html`

That will be our basic template (layout), we define a **django placeholder**. And we will modify the index.html file.

THE BASE template IS OUR LAYOUT from BOOTSTRAP starter template:

`vidly/movies/templates/movies/base.html`

```django-html
<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <title>Vidly Movie Application</title>
  </head>
  <body>
    {% block content %}
    {% endblock  %}

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
  </body>
</html>
```

WE change the index accordingly:

`vidly/movies/templates/movies/index.html`

```django-html
    {% extends 'movies/base.html' %}
    {% block content %}
    <table class="table">
        <thead>
            <th>Title</th>
            <th>Genre</th>
            <th>Stock</th>
            <th>Daily Rate</th>
        </thead>
        <tbody>
            {% for movie in movies %}
                <tr>
                    <td>{{movie.title}}</td>
                    <td>{{movie.genre}}</td>
                    <td>{{movie.number_in_stock}}</td>
                    <td>{{movie.daily_rate}}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% endblock  %}
```

### Customizing the layout

We are going to add a bootstrap navigation bar.

```django-html
<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <title>Vidly Movie Application</title>
  </head>
  <body>
    <nav class="navbar navbar-light bg-light">
      <a class="navbar-brand" href="#">Vidly</a>
    </nav>
    <main class="container">
    {% block content %}
    {% endblock  %}
    </main>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
  </body>
</html>
```

```django-python
    {% extends 'movies/base.html' %}
    {% block content %}
    <table class="table table-bordered table-hover">
        <thead>
            <th>Title</th>
            <th>Genre</th>
            <th>Stock</th>
            <th>Daily Rate</th>
        </thead>
        <tbody>
            {% for movie in movies %}
                <tr>
                    <td>{{movie.title}}</td>
                    <td>{{movie.genre}}</td>
                    <td>{{movie.number_in_stock}}</td>
                    <td>{{movie.daily_rate}}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% endblock  %}

```

WE have modified our table by adding some bootstrap. Next we put our content inside a main element inside our layout.

### Share Template across multiple apps

We are going to create a proper directory outside the **movies directory (app)**.

- we have a template global outside the movies directory now.

#### Tell django to look inside that global Template directory

1. Put base.html inside the global template folder.

- `vidly/templates/base.html`

2. Specify the existence of the global templates directory inside of django.

- `vidly/vidly/settings.py`

```python
TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        # DIRS was empty, we set it to see
        # the templates directory
        'DIRS': [os.path.join(BASE_DIR, 'templates')],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]
```

3. we implement the change inside our index.html

```django-html
    {% extends 'base.html' %}
    {% block content %}
    <table class="table table-bordered table-hover">
        <thead>
            <th>Title</th>
            <th>Genre</th>
            <th>Stock</th>
            <th>Daily Rate</th>
        </thead>
        <tbody>
            {% for movie in movies %}
                <tr>
                    <td>{{movie.title}}</td>
                    <td>{{movie.genre}}</td>
                    <td>{{movie.number_in_stock}}</td>
                    <td>{{movie.daily_rate}}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endblock  %}
```

### URL Parameters

We are about to implement some options of the CRUD.

> A Show Routes: (Read) like sinatra = `/movies/:id`

GO: `vidly/movies/urls.py` ,`vidly/vidly/urls.py`
AND `vidly/movies/views.py`

To establish the first plumbings

```python
from django.http import HttpResponse
from django.shortcuts import render
from .models import Movie

# Create your views here.


def index(request):
    movies = Movie.objects.all()
    #output = " ".join([m.title for m in movies])
    # return HttpResponse(output)
    return render(request, 'movies/index.html', {'movies': movies})


def detail(request, movie_id):
    return HttpResponse(movie_id)

# we must create our template now
# create a urls.py to mapp this index

```

```python
"""vidly URL Configuration

The `urlpatterns` list routes URLs to views. For more information please see:
    https://docs.djangoproject.com/en/2.2/topics/http/urls/
Examples:
Function views
    1. Add an import:  from my_app import views
    2. Add a URL to urlpatterns:  path('', views.home, name='home')
Class-based views
    1. Add an import:  from other_app.views import Home
    2. Add a URL to urlpatterns:  path('', Home.as_view(), name='home')
Including another URLconf
    1. Import the include() function: from django.urls import include, path
    2. Add a URL to urlpatterns:  path('blog/', include('blog.urls'))
"""
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    # movies/movie.urls
    path('movies/', include('movies.urls'))
]

```

```python
from django.urls import path
from . import views
urlpatterns = [
    path('', views.index, name='movies_index'),
    # we have set django to apply this behavior:
    # movies/movie_id
    # make sure it's an integer
    path('<int:movie_id>', views.detail, name='movies_detail')
]

```

### Get a single object

So earlier the piece that was missing was the way to get the id from the models.

- The django urls manager still the same:

```python
"""vidly URL Configuration

The `urlpatterns` list routes URLs to views. For more information please see:
    https://docs.djangoproject.com/en/2.2/topics/http/urls/
Examples:
Function views
    1. Add an import:  from my_app import views
    2. Add a URL to urlpatterns:  path('', views.home, name='home')
Class-based views
    1. Add an import:  from other_app.views import Home
    2. Add a URL to urlpatterns:  path('', Home.as_view(), name='home')
Including another URLconf
    1. Import the include() function: from django.urls import include, path
    2. Add a URL to urlpatterns:  path('blog/', include('blog.urls'))
"""
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    # movies/movie.urls
    path('movies/', include('movies.urls'))
]
```

- The real change is implemented in the URLS/VIEWS:

```python
from django.urls import path
from . import views
urlpatterns = [
    path('', views.index, name='movies_index'),
    # we have set django to apply this behavior:
    # movies/movie_id
    # make sure it's an integer
    path('<int:movie_id>', views.detail, name='movies_detail')
]
```

```python
from django.http import HttpResponse
from django.shortcuts import render
from .models import Movie

# Create your views here.


def index(request):
    movies = Movie.objects.all()
    #output = " ".join([m.title for m in movies])
    # return HttpResponse(output)
    return render(request, 'movies/index.html', {'movies': movies})


def detail(request, movie_id):
    movie = Movie.objects.get(id=movie_id)
    return render(request, 'movies/detail.html', {'movie': movie})

# we must create our template now
# create a urls.py to mapp this index
```

### Raising 404 errors

We must learn to return standard `https: 404` errors.

SEE The BASIC Pattern:

```python
from django.http import HttpResponse, Http404
from django.shortcuts import render
from .models import Movie

(..)
def detail(request, movie_id):
    try:
        movie = Movie.objects.get(id=movie_id)
        return render(request, 'movies/detail.html', {'movie': movie})
    except Movie.DoesNotExist:
        raise Http404()

```

WE CAN IMPLEMENT A BETTER APPROCH

```python
from django.http import HttpResponse, Http404
from django.shortcuts import render, get_object_or_404
from .models import Movie

# Create your views here.


def index(request):
    movies = Movie.objects.all()
    #output = " ".join([m.title for m in movies])
    # return HttpResponse(output)
    return render(request, 'movies/index.html', {'movies': movies})


def detail(request, movie_id):
    #movie = Movie.objects.get(id=movie_id)
    movie = get_object_or_404(Movie, id=movie_id)
    return render(request, 'movies/detail.html', {'movie': movie})


# we must create our template now
# create a urls.py to mapp this index

```

### Referencing URLS

We can add anchor tags and reference the link, we have created with the magic of our plumbings.

AN Approch possible:

`vidly/movies/templates/movies/index.html`

```django-html
    {% extends 'base.html' %}
    {% block content %}
    <table class="table table-bordered table-hover">
        <thead>
            <th>Title</th>
            <th>Genre</th>
            <th>Stock</th>
            <th>Daily Rate</th>
        </thead>
        <tbody>
            {% for movie in movies %}
                <tr>
                    <td><a href="/movies/{{movie.id}}">{{movie.title}}</a></td>
                    <td>{{movie.genre}}</td>
                    <td>{{movie.number_in_stock}}</td>
                    <td>{{movie.daily_rate}}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% endblock  %}
```

> WE can do an impementation to prevent our apps from breaking.

we can reference the urls using their names.

`vidly/movies/urls.py`

```python
from django.urls import path
from . import views
urlpatterns = [
    path('', views.index, name='movies_index'),
    # we have set django to apply this behavior:
    # movies/movie_id
    # make sure it's an integer
    path('<int:movie_id>', views.detail, name='movies_detail')
]

```

> Using the name argument of the path methods

We are going to add our **url template tag** inside the anchor tags.

```django-html
    {% extends 'base.html' %}
    {% block content %}
    <table class="table table-bordered table-hover">
        <thead>
            <th>Title</th>
            <th>Genre</th>
            <th>Stock</th>
            <th>Daily Rate</th>
        </thead>
        <tbody>
            {% for movie in movies %}
                <tr>
                    <td><a href="{% url 'movies_detail' movie.id%}">{{movie.title}}</a></td>
                    <td>{{movie.genre}}</td>
                    <td>{{movie.number_in_stock}}</td>
                    <td>{{movie.daily_rate}}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% endblock  %}

```

NOW INSIDE OUR `vidly/movies/urls.py` WE STILL CAN DO A BETTER IMPLEMENTATION and change our templates.

```python
from django.urls import path
from . import views

app_name = 'movies'

urlpatterns = [
    path('', views.index, name='index'),
    # we have set django to apply this behavior:
    # movies/movie_id
    # make sure it's an integer
    # no need for movies_index and movies_detail
    # the app_name property insure that django will
    # know our to deals with these urls.

    path('<int:movie_id>', views.detail, name='detail')
]
```

```django-html
    {% extends 'base.html' %}
    {% block content %}
    <table class="table table-bordered table-hover">
        <thead>
            <th>Title</th>
            <th>Genre</th>
            <th>Stock</th>
            <th>Daily Rate</th>
        </thead>
        <tbody>
            {% for movie in movies %}
                <tr>
                    <td><a href="{% url 'movies:detail' movie.id%}">{{movie.title}}</a></td>
                    <td>{{movie.genre}}</td>
                    <td>{{movie.number_in_stock}}</td>
                    <td>{{movie.daily_rate}}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% endblock  %}
```

### Creating API

We are going an API for our movies application. Our goals is to expose end-points for other developoers to work with.

TWO Framework that can help to expose our **consuming api**:

- django-tastypie
- djangorestframework

```bash
(vidly) bash-3.2$ pipenv install django-tastypie
```

We must create another apps inside our `vidly` project.

```bash
(vidly) bash-3.2$ python3 manage.py startapp api
```

This app will **be responsible for exposing our api endpoints**

REGISTER:

- we go inside `vidly/vidly/setting.py`
- reference the config class of the api app (`/vidly/api/apps.py`).

```python
(..)
# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'movies.apps.MoviesConfig',
    'api.apps.ApiCongig'
]
(..)
```

```python
from django.apps import AppConfig


class ApiConfig(AppConfig):
    name = 'api'

```

#### Step2 (REST)

Representational State Transfer API

Go: `vidly/api/models.py`

we are go build of rest api situation

```python
from django.db import models
from tastypie.resources import ModelResource
from movies.models import Movie
# Build REST API (resources)


class MovieResource(ModelResource):
    class Meta:
        # lazy loading
        queryset = Movie.object.all()
        # will help with `/movie/api/movie`
        resource_name = "movies"
        xcludes = ['date_created']
```

Go: `vidly/vidly/urls.py`

```python
from django.contrib import admin
from django.urls import path, include
from api.models import MovieResource

movie_resource = MovieResource()

urlpatterns = [
    path('admin/', admin.site.urls),

    path('movies/', include('movies.urls')),
    # api expose
    path('api/', include(movie_resource.urls))
]

```

#### Complete API for Genre and Movie

```python
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'movies.apps.MoviesConfig',
    'api.apps.ApiConfig'
]
```

MOVIES MODELS

```python
from django.db import models
from django.utils import timezone
# Create your models here.


class Genre(models.Model):
    # use field
    name = models.CharField(max_length=255)
    # override the default __str__

    def __str__(self):
        return self.name


class Movie(models.Model):
    # use field
    title = models.CharField(max_length=255)
    release_year = models.IntegerField()
    number_in_stock = models.IntegerField()
    daily_rate = models.FloatField()
    # association has-many and belongs to
    # on delete will tell django how to handle
    # a delete event of a genre given.

    genre = models.ForeignKey(Genre, on_delete=models.CASCADE)

    date_created = models.DateTimeField(default=timezone.now)
```

API MODELS

```python
from django.db import models
from tastypie.resources import ModelResource
from movies.models import Movie, Genre
# Build REST API (resources)


class MovieResource(ModelResource):
    class Meta:
        # lazy loading
        queryset = Movie.objects.all()
        # will help with `/movie/api/movie`
        resource_name = "movies"
        excludes = ['date_created']


class GenreResource(ModelResource):
    class Meta:
        # lazy loading
        queryset = Genre.objects.all()
        # will help with `/movie/api/movie`
        resource_name = "genres"

```

VIDLY URLS

```python
from django.contrib import admin
from django.urls import path, include
from api.models import MovieResource, GenreResource

movie_resource = MovieResource()
genre_resource = GenreResource()

urlpatterns = [
    path('admin/', admin.site.urls),

    path('movies/', include('movies.urls')),
    # api expose
    path('api/', include(movie_resource.urls)),
    path('api/', include(genre_resource.urls))
]
```

ANd the two api are working!!!!

### The HomePage

We are going to manually create the home page. We are heading to `vidly/vidly/views.py (created)`.

A good approch is to add similar page like the hompage inside the global templates file.

#### the plumbings

- we add the home page `home.html` inside the global templates (`vidly/templates/home.html`).
- we built the views for the home (`vidly/vidly/views.py (created)`).
- we register the proper urls (`vidly/vidly/urls.py`)
- remember how we register the apps = (movies, api) and the gobal templates inside the `vidly/vidly/setting.py`

```django.html
{% extends 'base.html' %}

{% block content %}
<h1> Welcome to the Vidly movie application</h1>
<a href='{% url 'movies:index' %}'>See your movies</a>
{% endblock  %}
```

```python
from django.shortcuts import render

def home(request):
    return render(request,'home.html')


# We need to map this views to our url endpoint
```

```python
from django.contrib import admin
from django.urls import path, include
from api.models import MovieResource, GenreResource
from . import views

movie_resource = MovieResource()
genre_resource = GenreResource()

urlpatterns = [
    # homepage
    path('', views.home),
    # admin and moveis
    path('admin/', admin.site.urls),
    path('movies/', include('movies.urls')),
    # api expose
    path('api/', include(movie_resource.urls)),
    path('api/', include(genre_resource.urls))
]
```

And The settings

```python
(..)
# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'movies.apps.MoviesConfig',
    'api.apps.ApiConfig'
]

(..)

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [os.path.join(BASE_DIR, 'templates')],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]
(..)
```

### Deployment

1. Heroku account
2. download Heroku cli (do `heroku update`)
3. Install and use GIT
4. gunicorn (`pipenv isntall gunicorn`)
5. At the `vidly/Procfile` add the Procfile file.
6. resolve the static file situation `vidly/vidly/settings.py` and create a static file `vidly/static`.

- `python3 manage.py collectstatic`

7. to send the static to heroku. `pipenv install whitenoise`

we need to copy and enable the whitenoise middleware inside the settings.py after the security middleware:

```python

MIDDLEWARE = [
  # 'django.middleware.security.SecurityMiddleware',
  'whitenoise.middleware.WhiteNoiseMiddleware',
  # ...
]
```

#### THE DEPLOYMENT PROCESS => HEROKU

1. Log to heroku `heroku login`
2. `heroku create`

- the random app created by heroku:

```bash
Alexandros-MacBook-Pro:Vidlyapp alexandrodisla$ heroku create advidlyapp
Creating ? advidlyapp... done
https://advidlyapp.herokuapp.com/ | https://git.heroku.com/advidlyapp.git
```

3. git push heroku master If you are working only locally. when you are working locally you init the files and commit.

```bash
Alexandros-MacBook-Pro:Vidlyapp alexandrodisla$ git push heroku master
Enumerating objects: 178, done.
Counting objects: 100% (178/178), done.
Delta compression using up to 4 threads
Compressing objects: 100% (172/172), done.
Writing objects: 100% (178/178), 576.00 KiB | 6.47 MiB/s, done.
Total 178 (delta 38), reused 0 (delta 0)
remote: Compressing source files... done.
remote: Building source:
remote:
remote: -----> Python app detected
remote: -----> Installing python-3.7.3
remote: -----> Installing pip
remote: -----> Installing dependencies with Pipenv 2018.5.18…
remote:        Installing dependencies from Pipfile.lock (ddc567)…
remote: -----> Installing SQLite3
remote: -----> $ python manage.py collectstatic --noinput
remote:        119 static files copied to '/tmp/build_ac1aad0c738d38ef1a67aa1b1c98d0f7/static'.
remote:
remote: -----> Discovering process types
remote:        Procfile declares types -> web
remote:
remote: -----> Compressing...
remote:        Done: 68.7M
remote: -----> Launching...
remote:        Released v5
remote:        https://advidlyapp.herokuapp.com/ deployed to Heroku
remote:
remote: Verifying deploy... done.
To https://git.heroku.com/advidlyapp.git
 * [new branch]      master -> master
```

4. Allocate a web server to the application `heroku ps:scale web=1`

```bash
Alexandros-MacBook-Pro:Vidlyapp alexandrodisla$ heroku ps:scale web=1
Scaling dynos... done, now running web at 1:Free
```

5. `heroku open` we will get an error. solve it 'vidly/vidly/settings.py`

```python
ALLOWED_HOSTS = ['advidlyapp.herokuapp.com']
```

6. `git push heroku master`
